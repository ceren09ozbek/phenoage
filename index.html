<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Biyolojik Yaş Hesaplayıcı</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f6f7fb; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card {
      background: #fff; border: 1px solid #e8e8ef; border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06); padding: 18px;
    }
    h1 { margin: 0 0 6px; font-size: 20px; }
    p.muted { margin: 0 0 16px; color: #555; font-size: 13px; line-height: 1.35; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 860px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }
    label { display: block; font-size: 12px; color: #333; margin: 0 0 6px; }
    input {
      width: 100%; padding: 10px 10px;
      border: 1px solid #d6d6e2; border-radius: 10px;
      outline: none; font-size: 14px; background: #fff;
    }
    input:focus { border-color: #6b7cff; box-shadow: 0 0 0 3px rgba(107,124,255,.15); }
    .row { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    button {
      border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600;
      cursor: pointer;
    }
    .primary { background: #2f6fed; color: #fff; }
    .ghost { background: #eef2ff; color: #233; }
    .danger { background: #ffecec; color: #a11; }
    .result {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .box {
      border: 1px solid #e8e8ef; border-radius: 12px; padding: 12px;
      background: #fafbff;
    }
    .kpi { font-size: 28px; font-weight: 800; margin: 4px 0 0; }
    .small { font-size: 12px; color: #444; }
    .warn { color: #a11; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    th, td { padding: 8px 8px; border-bottom: 1px solid #e6e6f2; text-align: left; }
    th { color: #333; font-size: 12px; }
    .footer-note { margin-top: 14px; font-size: 12px; color: #666; }
    code { background: #f0f1ff; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <div style="text-align:center; margin-bottom:12px;">
  <img src="life_logo.png"
       alt="Acıbadem Life"
       style="max-width:180px; height:auto;" />
</div>

      <h1>Biyolojik Yaş Hesaplayıcı</h1>
      <p class="muted">
        <br/><strong>Kaynak:</strong> Cramer, J. G., et al. (2020). An epigenetic biomarker of aging for lifespan and healthspan. National Library of Medicine.
        <br/><br/>
        <a href="https://pubmed.ncbi.nlm.nih.gov/29676998/" target="_blank" rel="noopener noreferrer">
  https://pubmed.ncbi.nlm.nih.gov/29676998/
</a>
        <br/><br/>
        <strong>Not:</strong> 1 parametre eksikse normalize edilir; 2 veya daha fazlası eksikse hesaplama yapılmaz.
        <br/><hr/>
      </p>

      <div class="grid" id="formGrid"></div>

      <div class="row">
        <button class="primary" id="btnCalc">Hesapla</button>
        <button class="ghost" id="btnAutofill">Örnek Doldur</button>
        <button class="danger" id="btnClear">Temizle</button>
      </div>

      <div class="result" id="resultArea" style="display:none;">
        <div class="box">
          <div class="small">Biyolojik Yaş (DNA Age)</div>
          <div class="kpi" id="dnaAgeText">-</div>
          <div class="small" id="normInfo"></div>
          <div class="small warn" id="errorText" style="display:none;"></div>
        </div>

        <div class="box">
          <div class="small"><b>Uyarı</b> (1 parametre eksikse normalizasyon uygulanabilir)</div>
          <div id="valuesTable"></div>
        </div>
      </div>
      <div class="footer-note">
      </div>
    </div>
  </div>

<script>
  // Normal değerler
  const NORMALIZED_VALUES = {
    albumin: 4.35, creatinin: 0.95, glucose: 85.0, crp: 0.25,
    lympocyte: 35.0, mcv: 90.0, rdw: 13.4, alp: 84.5, wbc: 7.33
  };

    // Referans aralıkları
  const REF_MIN = {
    albumin: 3.50, creatinin: 0.70, glucose: 70.0, crp: 0,
    lympocyte: 20.0, mcv: 80.0, rdw: 11.50, alp: 40.0, wbc: 4.06
  };

    const REF_MAX = {
    albumin: 5.20, creatinin: 1.20, glucose: 100.0, crp: 0.50,
    lympocyte: 50.0, mcv: 100.0, rdw: 15.30, alp: 129.0, wbc: 10.60
  };

  const katsayilar = {
    albumin: 10, creatinin: 88.4, glucose: 0.0555, crp: 0.1,
    lympocyte: 1, mcv: 1, rdw: 1, alp: 1, wbc: 1, age: 1
  };

  const wts = {
    albumin: -0.0336, creatinin: 0.0095, glucose: 0.1953, crp: 0.0954,
    lympocyte: -0.012, mcv: 0.0268, rdw: 0.3306, alp: 0.0019,
    wbc: 0.0554, age: 0.0804
  };

  // Form alanları
  const FIELDS = [
    { key: "albumin",   label: "Albumin",   placeholder: "g/dL (örn 4.1)" },
    { key: "creatinin", label: "Kreatinin", placeholder: "mg/dL (örn 1.02)" },
    { key: "glucose",   label: "Glukoz",    placeholder: "mg/dL (örn 92)" },
    { key: "crp",       label: "CRP",       placeholder: "mg/dL (örn 0.50)" },
    { key: "lympocyte", label: "Lenfosit",  placeholder: "% (örn 32)" },
    { key: "mcv",       label: "MCV",       placeholder: "fL (örn 88)" },
    { key: "rdw",       label: "RDW",       placeholder: "% (örn 13.1)" },
    { key: "alp",       label: "ALP",       placeholder: "U/L (örn 85)" },
    { key: "wbc",       label: "WBC",       placeholder: "10^3/uL (örn 7.0)" },
    { key: "age",       label: "Kronolojik Yaş", placeholder: "yıl (örn 42)" }
  ];

  // UI 
  const grid = document.getElementById("formGrid");
  FIELDS.forEach(f => {
    const div = document.createElement("div");
    div.innerHTML = `
      <label for="${f.key}">${f.label}</label>
      <input id="${f.key}" inputmode="decimal" placeholder="${f.placeholder}" />
    `;
    grid.appendChild(div);
  });

  function parseNumber(val) {
    if (val === null || val === undefined) return null;
    const s = String(val).trim().replace(",", ".");
    if (!s) return null;
    const x = Number(s);
    return Number.isFinite(x) ? x : null;
  }

  function calculate_dna_age_from_inputs(rawValues) {
    // rawValues: {albumin, creatinin, glucose, crp, lympocyte, mcv, rdw, alp, wbc, age}
    const values = { ...rawValues };

    // Eksik kontrol
    const missing = Object.keys(values).filter(k => values[k] === null || values[k] === undefined);

    // Yaş eksikse bu da eksik sayılır (Python kodunda age zorunlu)
    // Not: normalize listede age yok; dolayısıyla age eksikse normalize edilmez.
    // Aşağıdaki kural: age eksikse direkt hata.
    if (values.age === null) {
      throw new Error("Yaş boş olamaz. Hesaplama için zorunlu.");
    }

    // 2+ eksik -> hata (Python: >=2)
    if (missing.length >= 2) {
      throw new Error("İki veya daha fazla parametre eksik, hesaplama yapılamaz.");
    }

    let normalized_param = null;

    // 1 eksik -> normalizasyon (age hariç)
    if (missing.length === 1) {
      const eksik = missing[0];
      if (!(eksik in NORMALIZED_VALUES)) {
        // age gibi normalize listesinde yoksa
        throw new Error(`Eksik parametre (${eksik}) normalize edilemiyor. Lütfen doldurun.`);
      }
      values[eksik] = NORMALIZED_VALUES[eksik];
      normalized_param = eksik;
    }

    // c_input hesapla (Python ile aynı)
    const c_input = {};
    for (const k of Object.keys(katsayilar)) {
      if (k === "crp") {
        // Python: log(values["crp"] * 0.1)
        const v = values[k] * katsayilar[k];
        if (v <= 0) throw new Error("CRP değeri (log) için 0'dan büyük olmalı.");
        c_input[k] = Math.log(v);
      } else {
        c_input[k] = values[k] * katsayilar[k];
      }
    }

    // terms
    let terms = 0;
    for (const k of Object.keys(wts)) {
      terms += c_input[k] * wts[k];
    }

    const lincomb = -19.9067 + terms;
    const yaslanma_hizi = 0.0076927;
    const zaman = 120;

    const mortalite_score =
      1 - Math.exp(
        -Math.exp(lincomb) * (Math.exp(yaslanma_hizi * zaman) - 1) / yaslanma_hizi
      );

    const safe = Math.max(1 - mortalite_score, 1e-10);
    const inner = -0.00553 * Math.log(safe);

    // Python: 141.50225 + log(abs(inner)) / 0.09165
    const ptypic_age = 141.50225 + Math.log(Math.abs(inner)) / 0.09165;

    // Python: dna_age = ptypic_age / (1 + 1.28047 * exp(0.0344329 * (-182.344 + ptypic_age)))
    const dna_age = ptypic_age / (1 + 1.28047 * Math.exp(0.0344329 * (-182.344 + ptypic_age)));

    return {
      dna_age: Math.round(dna_age * 100) / 100,
      normalized_param,
      values
    };
  }

function renderValuesTable(values) {
  const rows = Object.entries(values).map(([k, v]) => {
    const label = (FIELDS.find(x => x.key === k)?.label) || k;

    const refMin = (k !== "age" && REF_MIN[k] !== undefined) ? REF_MIN[k] : "-";
    const refMax = (k !== "age" && REF_MAX[k] !== undefined) ? REF_MAX[k] : "-";

    return `
      <tr>
        <td>${label}</td>
        <td>${Number.isFinite(v) ? v : "-"}</td>
        <td>${refMin}</td>
        <td>${refMax}</td>
      </tr>
    `;
  }).join("");

  return `
    <table>
      <thead>
        <tr>
          <th>Parametre</th>
          <th>Değer</th>
          <th>REF_MIN</th>
          <th>REF_MAX</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}


  function getFormValues() {
    const obj = {};
    FIELDS.forEach(f => {
      obj[f.key] = parseNumber(document.getElementById(f.key).value);
    });
    return obj;
  }

  function setFormValues(obj) {
    FIELDS.forEach(f => {
      const el = document.getElementById(f.key);
      el.value = (obj[f.key] ?? "").toString().replace(".", ",");
    });
  }

  // Butonlar
  const resultArea = document.getElementById("resultArea");
  const dnaAgeText = document.getElementById("dnaAgeText");
  const normInfo = document.getElementById("normInfo");
  const errorText = document.getElementById("errorText");
  const valuesTable = document.getElementById("valuesTable");

  document.getElementById("btnCalc").addEventListener("click", () => {
    errorText.style.display = "none";
    resultArea.style.display = "block";

    try {
      const vals = getFormValues();
      const out = calculate_dna_age_from_inputs(vals);

      dnaAgeText.textContent = out.dna_age;
      normInfo.textContent = out.normalized_param
        ? `Normalize edilen parametre: ${out.normalized_param} (${NORMALIZED_VALUES[out.normalized_param]})`
        : "Normalizasyon uygulanmadı.";
      valuesTable.innerHTML = renderValuesTable(out.values);

    } catch (e) {
      dnaAgeText.textContent = "-";
      normInfo.textContent = "";
      valuesTable.innerHTML = "";
      errorText.textContent = e.message || String(e);
      errorText.style.display = "block";
    }
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    setFormValues({});
    resultArea.style.display = "none";
  });

  document.getElementById("btnAutofill").addEventListener("click", () => {
    // Örnek değerler (demo)
    setFormValues({
      albumin: 4.1, creatinin: 1.02, glucose: 92, crp: 0.8,
      lympocyte: 32, mcv: 88, rdw: 13.1, alp: 85, wbc: 7.0, age: 42
    });
    resultArea.style.display = "none";
  });
</script>
</body>
</html>
